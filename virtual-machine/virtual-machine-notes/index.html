<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Virtual Machine - My Notes</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Virtual Machine";
        var mkdocs_page_input_path = "virtual-machine/virtual-machine-notes.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> My Notes
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../backup/backup-notes/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../cli/cli-notes/">CLI</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../containers/container-notes/">Containers</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">DNS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../dns/dns-notes/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Configs</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../dns/configs/blocky-config.yml">blocky-config.yml</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../dns/configs/unbound.conf">unbound.conf</a>
                </li>
    </ul>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../git/git-notes/">Git</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Network</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../network/networking-notes/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../network/cisco-notes/">Cisco</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Configs</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../network/configs/interfaces">interfaces</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../network/configs/nftables.conf">nftables.conf</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Sysadmin</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../sysadmin/sysadmin-notes/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sysadmin/databases-notes/">Databases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sysadmin/erpnext-notes/">ERPNext</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sysadmin/wordpress-notes/">WordPress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sysadmin/selinux-notes/">SELinux</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >CoreOS</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/fedora-coreos/fedora-coreos-notes/">Fedora coreOS</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/fedora-coreos/basic.bu">basic.bu</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Systemd Examples</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/systemd_examples/app.service">app.service</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/systemd_examples/freedns.service">freedns.service</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/systemd_examples/freedns.timer">freedns.timer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/systemd_examples/rclone.service">rclone.service</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Configs</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/configs/sshd_config">sshd_config</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Scripts</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../sysadmin/scripts/wg-gen.sh">wg-gen.sh</a>
                </li>
    </ul>
                  </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Virtual Machine</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#installation-and-setup">Installation and Setup</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#configuring-virsh-for-non-root-user">Configuring virsh for non-root user</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#enable-virtualization">Enable Virtualization</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#manage-virtual-machines-with-virsh">Manage virtual machines with virsh</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#create-a-disk-image-for-the-virtual-machine">Create a disk image for the virtual machine</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#run-the-virtual-machine-from-serial-with-virt-install">Run the virtual machine from serial with virt install</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#converting-from-raw-to-qcow2">Converting from raw to qcow2</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mount-qcow2-image">Mount qcow2 image</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mount-raw-image-or-linux-volume">Mount raw image or linux volume</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mount-with-virtiofsd">Mount with virtiofsd</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#upgrade-debian-libvirt-packages">Upgrade Debian libvirt packages</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#run-virtiofsd-as-a-systemd-service">Run virtiofsd as a systemd service</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#add-the-xml-to-the-vm">Add the xml to the vm</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web/web-server-notes/">Web</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">My Notes</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Virtual Machine</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="virtual-machine-notes">Virtual Machine Notes</h1>
<h2 id="installation-and-setup">Installation and Setup</h2>
<h3 id="configuring-virsh-for-non-root-user">Configuring virsh for non-root user</h3>
<ol>
<li>Add your user to group libvirt</li>
<li>Write the configuration to ~/.config/libvirt/libvirt.conf</li>
</ol>
<pre><code class="language-bash">sudo usermod -a -G libvirt user
mkdir -p ~/.config/libvirt/
echo 'uri_default = &quot;qemu:///system&quot;' | tee -a ~/.config/libvirt/libvirt.conf
</code></pre>
<h3 id="enable-virtualization">Enable Virtualization</h3>
<p>For installing virtual machines without graphics we need
 to have some things installed and then enable libvirt daemon</p>
<pre><code class="language-bash">apt install qemu qemu-kvm qemu-system qemu-utils \
    libvirt-clients libvirt-daemon-system virtinst \
    virt-manager bridge-utils
# or
dnf install @virtualization
systemctl enable libvirtd
</code></pre>
<h2 id="manage-virtual-machines-with-virsh">Manage virtual machines with virsh</h2>
<h3 id="create-a-disk-image-for-the-virtual-machine">Create a disk image for the virtual machine</h3>
<pre><code class="language-bash">qemu-img create -f qcow2 ./name.qcow2 8G
</code></pre>
<h3 id="run-the-virtual-machine-from-serial-with-virt-install">Run the virtual machine from serial with virt install</h3>
<p>The important thing is using some parameters with the
 virt install, disable the graphics and enable a serial console.</p>
<pre><code class="language-bash">--graphics none \
--console pty,target_type=serial \
--extra-args 'console=ttyS0,115200n8 serial'
</code></pre>
<p>For the os-variant parameter, we need to know the system
 supported variants, you can do so with</p>
<pre><code class="language-bash">osinfo-query os
</code></pre>
<p>If you are using an ISO, you can use the cdrom parameter</p>
<pre><code class="language-bash">--cdrom ./example.iso \
</code></pre>
<p><strong>Debian example:</strong></p>
<pre><code class="language-bash">virt-install \
    --name debian11 \
    --memory 1024 \
    --disk path=./debian10.qcow2,size=8,format=qcow2,bus=virtio \
    --cpu host \
    --virt-type kvm \
    --vcpus 1 \
    --os-type linux \
    --os-variant debian11 \
    --network bridge=virbr0,model=virtio \
    --graphics none \
    --console pty,target_type=serial \
    --location 'http://your.url/installer' \
    --extra-args 'console=ttyS0,115200n8 serial'
</code></pre>
<p><strong>URLS:</strong></p>
<p>You may need to change architecture if running on aarch64</p>
<ul>
<li><a href="http://ftp.debian.org/debian/dists/stable/main/installer-amd64/">Debian Stable</a></li>
<li><a href="http://ftp.debian.org/debian/dists/oldstable/main/installer-amd64/">Debian OldStable</a></li>
<li><a href="http://ftp.debian.org/debian/dists/testing/main/installer-amd64/">Debian Testing</a></li>
<li><a href="http://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/">CentOS-stream9</a></li>
<li><a href="https://repo.almalinux.org/almalinux/8/BaseOS/x86_64/os/">Alma Linux 8</a></li>
<li><a href="https://repo.almalinux.org/almalinux/9/BaseOS/x86_64/os/">Alma Linux 9</a></li>
<li><a href="https://mirror.umd.edu/fedora/linux/releases/37/Everything/x86_64/os/">Fedora Everything 37</a></li>
</ul>
<h3 id="converting-from-raw-to-qcow2">Converting from raw to qcow2</h3>
<p>For converting raw (in this case a linux volume) to a qcow2 we
 must sparse it, so it does not use lots of space, in order to
 do this, first of all we need to install <code>libguestfs-tools-c</code></p>
<p><code>sh
dnf install libguestfs-tools-c</code></p>
<p>With that it will be installed the tool <code>virt-sparsify</code>, that is
 the one we need. Now we need to be sure that out /tmp directory
 is bigger than the raw image we are converting, may mount other
 drive in /tmp.</p>
<p>In orther to do the convertion, we can use</p>
<pre><code class="language-sh">virt-sparsify /dev/mapper/VG-VM --convert qcow2 /out/VM.qcow2 --check-tmpdir fail
</code></pre>
<p>The last flag is to check if the size of /tmp is enough.</p>
<h3 id="mount-qcow2-image">Mount qcow2 image</h3>
<p>For mounting:</p>
<pre><code class="language-sh">modprobe nbd max_part=8
qemu-nbd --connect=/dev/nbd0 ./image.qcow2
fdisk /dev/nbd0 -l
mount /dev/nbd0p1 /mnt
</code></pre>
<p>For unmounting:</p>
<pre><code class="language-sh">umount /mnt/somepoint/
qemu-nbd --disconnect /dev/nbd0
rmmod nbd
</code></pre>
<h3 id="mount-raw-image-or-linux-volume">Mount raw image or linux volume</h3>
<p>Create a loop device with</p>
<pre><code class="language-sh">losetup -f -P raw.img
</code></pre>
<p>You can see the open files with:</p>
<pre><code class="language-sh">losetup -l
fdisk -l
</code></pre>
<p>And mount it with:</p>
<pre><code class="language-sh">mount /dev/loop0p1 /mnt/mypartition
</code></pre>
<p>For unmounting and closing:</p>
<pre><code class="language-sh">umount /mnt/mypartition
losetup -d /dev/loop0p1
</code></pre>
<h3 id="mount-with-virtiofsd">Mount with virtiofsd</h3>
<p>I had a problem, I needed to mount a btrfs disk on a rhel9 vm,
 this is not supported, so I thought it would be a great idea
 to mount it on the Debian host and share it with virtiofsd,
 supporting selinux and all of that, it may not be the most
 secure way and it has some problems, so use it at your own
 risk.</p>
<h4 id="upgrade-debian-libvirt-packages">Upgrade Debian libvirt packages</h4>
<p>Debian 11 bullseye has an old libvirt package, so you need to
 upgrade them from backports, the packages are <code>qemu qemu-kvm
 qemu-system qemu-utils libvirt-clients libvirt-daemon-system
 virtinst</code> and after the upgrade you should restart libvirtd</p>
<h4 id="run-virtiofsd-as-a-systemd-service">Run virtiofsd as a systemd service</h4>
<p>In order to run virtiofsd in a socket, you should run it separated
 this can be done with a systemd service:</p>
<pre><code class="language-service">[Unit]
Description=Virtiofsd for sharing disk WD-WX32D5143K0L
Documentation=https://gitlab.com/virtio-fs/virtiofsd

[Service]
ExecStart=/usr/lib/qemu/virtiofsd --socket-path=/var/virtiofsd.sock \
    --socket-group=libvirt-qemu -o xattr,source=&quot;/mnt/Disk&quot;,\
    xattrmap=&quot;:map:security.selinux:trusted.virtiofs.:&quot;,modcaps=+sys_admin

 [Install]
WantedBy=multi-user.target
</code></pre>
<p>The extra options are 'xattr' for enabling those, 'source'
 to declare the dir to share, 'xattrmap' so you can have
 different selinux context on the host and the guest,
 'modcaps' so it is able to set trusted xattr. The service
 should run as root.</p>
<h4 id="add-the-xml-to-the-vm">Add the xml to the vm</h4>
<p>With <code>virsh edit</code> you should edit the domain xml to declare the
 socket</p>
<pre><code class="language-xml">&lt;filesystem type='mount'&gt;
  &lt;driver type='virtiofs' queue='1024'/&gt;
  &lt;source socket='/var/virtiofsd.sock'/&gt;
  &lt;target dir='myDisk'/&gt;
  &lt;alias name='fs0'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x07' slot='0x00' function='0x0'/&gt;
&lt;/filesystem&gt;
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../sysadmin/scripts/wg-gen.sh" class="btn btn-neutral float-left" title="wg-gen.sh"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../web/web-server-notes/" class="btn btn-neutral float-right" title="Web">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../sysadmin/scripts/wg-gen.sh" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../web/web-server-notes/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
